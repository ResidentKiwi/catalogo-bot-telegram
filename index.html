<!DOCTYPE html><html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Catálogo de Canais</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a2c5c4e6f4.js" crossorigin="anonymous"></script>
  <style>
    body {
      background-color: #121212;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      padding: 1rem;
    }
    .card {
      background-color: #1e1e1e;
      color: #fff;
      margin-bottom: 1rem;
      border: none;
      border-radius: 1rem;
    }
    .form-control, .form-select {
      background-color: #2c2c2c;
      color: #fff;
      border: none;
    }
    .form-control::placeholder {
      color: #aaa;
    }
    .btn-primary {
      background-color: #0d6efd;
    }
    .btn-danger {
      background-color: #dc3545;
    }
    .admin-panel {
      position: sticky;
      top: 0;
      z-index: 999;
      background-color: #121212;
      padding-bottom: 1rem;
    }
    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2000;
    }
    #listaCanais {
      margin-top: 1rem;
    }
    #adminInfo {
      font-size: 0.9rem;
      color: #bbb;
    }
    input[type="file"]::file-selector-button {
      background-color: #444;
      color: #fff;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 0.4rem;
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner-border text-light" role="status"></div>
  </div>  <div class="admin-panel d-none" id="adminPanel">
    <div class="card p-3">
      <p id="adminInfo" class="mb-2">
        <i class="fas fa-user-shield"></i> Conectado como: <strong id="adminUsername"></strong> (ID: <span id="adminUserId"></span>)
      </p>
      <h5>Adicionar novo canal</h5>
      <form id="canalForm">
        <input class="form-control mb-2" id="nome" placeholder="Nome do Canal" required />
        <input class="form-control mb-2" id="descricao" placeholder="Descrição" />
        <input class="form-control mb-2" id="url" placeholder="Link do Canal" required />
        <input class="form-control mb-3" type="file" id="imagemArquivo" accept="image/*" />
        <button type="submit" class="btn btn-success w-100">
          <i class="fas fa-plus"></i> Adicionar Canal
        </button>
      </form>
    </div>
  </div>  <div id="catalogo" class="row mt-3"></div>  <!-- Modal de edição -->  <div class="modal fade" id="editarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-white">
        <form id="editarForm">
          <div class="modal-header">
            <h5 class="modal-title">Editar Canal</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editId" />
            <input class="form-control mb-2" id="editNome" placeholder="Nome do Canal" required />
            <input class="form-control mb-2" id="editDescricao" placeholder="Descrição" />
            <input class="form-control mb-2" id="editUrl" placeholder="Link do Canal" required />
            <input class="form-control" type="file" id="editImagemArquivo" accept="image/*" />
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>  <script>
    const BACKEND_URL = "https://cat-logo-backend.onrender.com";
    let isAdmin = false;
    const loadingScreen = document.getElementById("loading");

    function criarCard(canal) {
      const col = document.createElement("div");
      col.className = "col-md-4 mb-4";
      col.innerHTML = `
        <div class="card h-100 shadow-sm">
          <img src="${canal.imagem}" class="card-img-top" alt="${canal.nome}">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">${canal.nome}</h5>
            <p class="card-text flex-grow-1">${canal.descricao}</p>
            <a href="${canal.url}" target="_blank" class="btn btn-outline-light mt-auto">
              <i class="fas fa-link me-1"></i>Acessar Canal
            </a>
            ${isAdmin ? `
              <div class="mt-2 d-flex justify-content-between">
                <button class="btn btn-sm btn-outline-secondary" onclick='abrirModalEdicao(${JSON.stringify(canal)})'>
                  <i class="fas fa-pen"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick='excluirCanal(${canal.id})'>
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            ` : ""}
          </div>
        </div>
      `;
      return col;
    }

    function renderizarCatalogo(canais) {
      const container = document.getElementById("catalogo");
      container.innerHTML = "";
      canais.forEach(canal => container.appendChild(criarCard(canal)));
    }

    async function carregarCanais() {
      loadingScreen.style.display = "flex";
      try {
        const res = await fetch(`${BACKEND_URL}/canais`);
        const canais = await res.json();
        renderizarCatalogo(canais);
      } catch (err) {
        alert("Erro ao carregar canais.");
        console.error(err);
      } finally {
        loadingScreen.style.display = "none";
      }
    }

    async function verificarAdmin(id) {
      const res = await fetch(`${BACKEND_URL}/admins/${id}`);
      const json = await res.json();
      return json.admin === true;
    }

    async function uploadImagem(arquivo) {
      const formData = new FormData();
      formData.append("file", arquivo);
      const res = await fetch(`${BACKEND_URL}/upload`, {
        method: "POST",
        body: formData,
      });
      const json = await res.json();
      return json.url;
    }

    async function adicionarCanal(event) {
      event.preventDefault();
      const nome = document.getElementById("nome").value;
      const descricao = document.getElementById("descricao").value;
      const url = document.getElementById("url").value;
      const imagemArquivo = document.getElementById("imagemArquivo").files[0];
      const imagemURL = await uploadImagem(imagemArquivo);

      await fetch(`${BACKEND_URL}/canais`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nome, descricao, url, imagem: imagemURL }),
      });

      document.getElementById("canalForm").reset();
      carregarCanais();
    }

    function abrirModalEdicao(canal) {
      document.getElementById("editId").value = canal.id;
      document.getElementById("editNome").value = canal.nome;
      document.getElementById("editDescricao").value = canal.descricao;
      document.getElementById("editUrl").value = canal.url;
      new bootstrap.Modal(document.getElementById("editarModal")).show();
    }

    async function editarCanal(event) {
      event.preventDefault();
      const id = document.getElementById("editId").value;
      const nome = document.getElementById("editNome").value;
      const descricao = document.getElementById("editDescricao").value;
      const url = document.getElementById("editUrl").value;
      const imagemArquivo = document.getElementById("editImagemArquivo").files[0];
      let body = { nome, descricao, url };

      if (imagemArquivo) {
        const imagemURL = await uploadImagem(imagemArquivo);
        body.imagem = imagemURL;
      }

      await fetch(`${BACKEND_URL}/canais/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      bootstrap.Modal.getInstance(document.getElementById("editarModal")).hide();
      carregarCanais();
    }

    async function excluirCanal(id) {
      if (!confirm("Deseja mesmo excluir este canal?")) return;
      await fetch(`${BACKEND_URL}/canais/${id}`, { method: "DELETE" });
      carregarCanais();
    }

    window.onload = async () => {
      if (!window.Telegram?.WebApp?.initDataUnsafe) {
        alert("Execute dentro do Telegram.");
        return;
      }
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();

      const user = Telegram.WebApp.initDataUnsafe.user;
      const userId = user?.id;
      const username = user?.username || "Desconhecido";

      isAdmin = await verificarAdmin(userId);

      if (isAdmin) {
        document.getElementById("adminPanel").classList.remove("d-none");
        document.getElementById("adminUsername").textContent = username;
        document.getElementById("adminUserId").textContent = userId;

        document.getElementById("canalForm").addEventListener("submit", adicionarCanal);
        document.getElementById("editarForm").addEventListener("submit", editarCanal);
      }

      await carregarCanais();
    }
  </script></body>
</html>
